<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
// --- Countries ---
const countries = ["South Africa","USA","Australia","Canada","UK","India","Kenya","Nigeria","Ghana","Eswatini"];
const countrySelect = document.getElementById('country');
countries.forEach(c => { 
  const opt=document.createElement('option'); 
  opt.value=c; 
  opt.textContent=c; 
  countrySelect.appendChild(opt); 
});

// --- Provinces/States ---
const countryLocations = {
  "South Africa":["Gauteng","Western Cape","KwaZulu-Natal","Eastern Cape","Limpopo","Mpumalanga","Northern Cape","North West","Free State"],
  "USA":["California","New York","Texas","Florida","Illinois","Pennsylvania","Ohio","Georgia"],
  "Australia":["New South Wales","Victoria","Queensland","South Australia","Western Australia","Tasmania","Northern Territory","ACT"],
  "Canada":["Ontario","Quebec","British Columbia","Alberta","Manitoba"],
  "UK":["England","Scotland","Wales","Northern Ireland"],
  "India":["Maharashtra","Delhi","Karnataka","Tamil Nadu","West Bengal","Gujarat","Rajasthan"],
  "Kenya":["Nairobi","Mombasa","Kisumu","Nakuru","Eldoret"],
  "Nigeria":["Lagos","Abuja","Port Harcourt","Kano","Ibadan"],
  "Ghana":["Accra","Kumasi","Tamale"],
  "Eswatini":["Mbabane","Manzini","Lobamba"]
};

// --- Offices per province/state including Home Affairs ---
const officeLocations = {
  "Mbabane":["Mbabane Home Affairs","Mbabane Regional Office 1","Mbabane Regional Office 2"],
  "Manzini":["Manzini Home Affairs","Manzini Branch 1","Manzini Branch 2"],
  "Lobamba":["Lobamba Home Affairs"],
  "Gauteng":["Pretoria Home Affairs","Johannesburg Home Affairs","Soweto Regional Office"],
  "Western Cape":["Cape Town Home Affairs","Stellenbosch Branch"],
  "KwaZulu-Natal":["Durban Home Affairs","Pietermaritzburg Branch"]
};

function updateLocations() {
  const country = countrySelect.value;
  const locSelect = document.getElementById('location');
  const officeSelect = document.getElementById('office');
  locSelect.innerHTML='<option value="">Select Location</option>';
  officeSelect.innerHTML='<option value="">Select Office</option>';
  if(countryLocations[country]){
    countryLocations[country].forEach(loc=>{
      const opt=document.createElement('option');
      opt.value=loc;
      opt.textContent=loc;
      locSelect.appendChild(opt);
    });
  }
}

function updateOffices(){
  const loc = document.getElementById('location').value;
  const officeSelect = document.getElementById('office');
  officeSelect.innerHTML='<option value="">Select Office</option>';
  if(officeLocations[loc] && officeLocations[loc].length>0){
    officeLocations[loc].forEach(off=>{
      const opt=document.createElement('option');
      opt.value=off;
      opt.textContent=off;
      officeSelect.appendChild(opt);
    });
  } else if(loc){
    const opt=document.createElement('option');
    opt.value=loc+" Home Affairs";
    opt.textContent=loc+" Home Affairs";
    officeSelect.appendChild(opt);
  }
}

// --- Datepicker ---
const disabledDateRanges=[{from:"2025-09-01",to:"2025-10-16"}];
const publicHolidays=["2025-09-24","2025-10-15","2025-10-23"];
function disableDates(date){
  const d = date.toISOString().split('T')[0];
  for(const r of disabledDateRanges) if(d>=r.from && d<=r.to) return true;
  return publicHolidays.includes(d);
}
flatpickr("#appointment_date",{dateFormat:"Y-m-d", minDate:"today", disable:[disableDates]});

// --- Form submission with duplicate prevention & booking number ---
const bookingForm=document.getElementById("bookingForm");
bookingForm.addEventListener("submit", function(e){
  e.preventDefault();

  let valid=true;
  bookingForm.querySelectorAll("input,select").forEach(el=>{
    if(!el.checkValidity()){el.classList.add("invalid"); valid=false;} else el.classList.remove("invalid");
  });
  if(!valid) return;

  const idNumber = document.getElementById("id_number").value.trim();
  if(!idNumber) { alert("ID Number is required"); return; }

  // --- Load all existing bookings ---
  let allBookings = JSON.parse(localStorage.getItem("allBookings")) || {};

  // --- Prevent duplicate booking ---
  if(allBookings[idNumber]){
    alert("Booking already exists. Redirecting to your summary page.");
    window.location.href = `summary.html?id=${idNumber}`;
    return;
  }

  // --- Collect booking data ---
  const bookingData = {
    id_number: idNumber,
    forenames: document.getElementById("forenames").value,
    surname: document.getElementById("surname").value,
    country: document.getElementById("country").value,
    location: document.getElementById("location").value,
    office: document.getElementById("office").value,
    appointment_date: document.getElementById("appointment_date").value,
    appointment_time: document.getElementById("appointment_time").value,
    booking_reference: "GG-" + idNumber + "-" + Date.now()
  };

  // --- Save booking ---
  allBookings[idNumber] = bookingData;
  localStorage.setItem("allBookings", JSON.stringify(allBookings));
  localStorage.setItem("bookingData", JSON.stringify(bookingData));

  // --- Redirect to summary page ---
  window.location.href = `summary.html?id=${idNumber}`;
});

// --- Prefill visa application from ID number ---
window.addEventListener("load", function(){
  const urlParams = new URLSearchParams(window.location.search);
  const idNumber = urlParams.get("id");
  if(!idNumber) return;

  const allBookings = JSON.parse(localStorage.getItem("allBookings")) || {};
  if(allBookings[idNumber]){
    const booking = allBookings[idNumber];
    const visaFields = ["id_number","forenames","surname","contact","email","booking_reference"];
    visaFields.forEach(field => {
      const el = document.getElementById(field);
      if(el) el.value = booking[field] || "";
    });
  }
});
</script>
