<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Select Office — Appointment</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <header class="brand">
      <h1>Select a Branch / Office</h1>
      <p class="subtitle">Choose the location where you will attend for passport / ID services.</p>
    </header>

    <main>
      <div class="controls">
        <label for="countryFilter">Filter by country</label>
        <select id="countryFilter">
          <option value="">-- All Countries --</option>
        </select>

        <label for="searchInput">Search office (city, name)</label>
        <input id="searchInput" type="search" aria-label="Search office by city or name" placeholder="Type a city or office name" />
      </div>

      <form id="officeForm" novalidate>
        <label for="officeSelect">Choose Branch / Office</label>
        <select id="officeSelect" required>
          <option value="">-- Select Location --</option>
        </select>

        <div id="officeDetails" class="office-details" aria-live="polite" hidden></div>

        <div class="button-group">
          <button type="submit" class="btn-auth">Continue</button>
          <button type="button" class="btn-back" onclick="location.href='index.html'">Back</button>
        </div>
      </form>
    </main>

    <footer><small>Data is sample/demo — verify addresses before use.</small></footer>
  </div>

  <script src="offices.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const countryFilter = document.getElementById('countryFilter');
      const officeSelect = document.getElementById('officeSelect');
      const searchInput = document.getElementById('searchInput');
      const officeDetails = document.getElementById('officeDetails');

      // Populate country filter dropdown
      const countries = Array.from(new Set(OFFICES.map(o => o.country))).sort();
      countries.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        countryFilter.appendChild(opt);
      });

      // Helper: format option label
      function formatOfficeOption(o) {
        return `${o.country} — ${o.city} — ${o.name}`;
      }

      // Render office options based on filters
      function renderOffices(filterCountry = '', search = '') {
        const filtered = OFFICES.filter(o => {
          if (filterCountry && o.country !== filterCountry) return false;
          if (search) {
            const s = search.toLowerCase();
            const hay = (o.name + ' ' + o.city + ' ' + (o.address || '')).toLowerCase();
            return hay.includes(s);
          }
          return true;
        });

        // Reset options
        officeSelect.innerHTML = '<option value="">-- Select Location --</option>';

        filtered.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.id;
          opt.textContent = formatOfficeOption(o);
          officeSelect.appendChild(opt);
        });

        // Reset details and selected value when re-rendering
        officeDetails.hidden = true;
        officeDetails.innerHTML = '';
        officeSelect.value = '';
      }

      // Show office details on selection
      function showDetailsById(id) {
        const o = OFFICES.find(x => x.id === id);
        if (!o) {
          officeDetails.hidden = true;
          officeDetails.innerHTML = '';
          return;
        }
        officeDetails.hidden = false;
        officeDetails.innerHTML = `
          <h3>${o.name} — ${o.city}, ${o.country}</h3>
          <p><strong>Address:</strong> ${o.address || 'N/A'}</p>
          <p><strong>Phone:</strong> ${o.phone || 'N/A'}</p>
          ${o.hours ? `<p><strong>Hours:</strong> ${o.hours}</p>` : ''}
          ${o.notes ? `<p><strong>Notes:</strong> ${o.notes}</p>` : ''}
        `;
      }

      // Initial render
      renderOffices();

      // Event listeners
      countryFilter.addEventListener('change', () => renderOffices(countryFilter.value, searchInput.value));
      searchInput.addEventListener('input', () => renderOffices(countryFilter.value, searchInput.value));
      officeSelect.addEventListener('change', () => showDetailsById(officeSelect.value));

      // Handle form submission
      document.getElementById('officeForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const selectedId = officeSelect.value;
        if (!selectedId) {
          alert('Please select an office.');
          return;
        }

        const selectedOffice = OFFICES.find(o => o.id === selectedId);
        if (!selectedOffice) {
          alert('Selected office not found.');
          return;
        }

        // Save selection to localStorage
        localStorage.setItem('selectedOffice', JSON.stringify(selectedOffice));

        // Redirect to booking page
        window.location.href = 'booking.html';
      });
    });
  </script>
</body>
</html>
