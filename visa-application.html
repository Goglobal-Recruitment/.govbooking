<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visa Application</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
    :root {
      --card: #ffffff;
      --muted: #6b7a8a;
      --accent: #0a6b3b;
      --accent-2: #2a8a55;
      --background: #e0f7fa;
      --font-family: 'Poppins', sans-serif;
      --border-light: #dce3ea;
      --radius: 12px;
      --shadow: rgba(0, 0, 0, 0.1);
    }
    body {
      font-family: var(--font-family);
      background-color: var(--background);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    main.visa-container {
      max-width: 900px;
      width: 100%;
      background-color: var(--card);
      padding: 2.5rem 3rem;
      border-radius: var(--radius);
      box-shadow: 0 8px 20px var(--shadow);
    }
    h1 {
      color: var(--accent);
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    form { display: flex; flex-direction: column; gap: 1.25rem; }
    fieldset { border: 1px solid var(--border-light); border-radius: 10px; padding: 1rem; }
    legend { font-weight: 600; color: var(--accent); }
    label { font-weight: 600; color: #3b3b3b; margin-top: 6px; }
    input, select, textarea {
      padding: 0.6rem 1rem;
      border-radius: 8px;
      border: 1.8px solid var(--border-light);
      font-size: 1rem;
      font-family: var(--font-family);
      resize: vertical;
      transition: border-color 0.3s ease;
      width: 100%;
    }
    input:focus, textarea:focus, select:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 5px var(--accent);
    }
    button {
      margin-top: 2rem; background-color: var(--accent); color: white;
      padding: 14px; font-size: 1.1rem; font-weight: 700;
      border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s ease;
    }
    button:hover { background-color: var(--accent-2); }
    .hidden { display: none; }
    .feedback { font-size: 0.9rem; margin-top: 0.5rem; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <main class="visa-container" role="main" aria-label="Visa Application Form">
    <h1>Visa Application</h1>
    <form id="visaForm" enctype="multipart/form-data">

      <fieldset>
        <legend>Personal & Appointment Details</legend>
        <label for="id_number">ID Number</label>
        <input type="text" id="id_number" name="id_number" readonly />
        <label for="forenames">Forenames</label>
        <input type="text" id="forenames" name="forenames" readonly />
        <label for="surname">Surname</label>
        <input type="text" id="surname" name="surname" readonly />
        <label for="cellphone">Cellphone</label>
        <input type="tel" id="cellphone" name="cellphone" readonly />
        <label for="email">Email</label>
        <input type="email" id="email" name="email" readonly />
        <label for="appointment_date">Appointment Date</label>
        <input type="text" id="appointment_date" name="appointment_date" readonly />
        <label for="appointment_time">Appointment Time</label>
        <input type="text" id="appointment_time" name="appointment_time" readonly />
      </fieldset>

      <fieldset>
        <legend>Extended Details</legend>
        <label>Street Address</label>
        <input type="text" name="street" required>
        <label>City</label>
        <input type="text" name="city" required>
        <label>Postal Code</label>
        <input type="text" name="postal" required>
        <label>Accommodation Address</label>
        <input type="text" name="accomAddress">
        <label>Upload Accommodation Proof</label>
        <input type="file" name="accomProof" accept="application/pdf,image/*">
      </fieldset>

      <fieldset>
        <legend>Passport Handling</legend>
        <label><input type="checkbox" id="noPassport" name="noPassport"> I do not have a passport / Applying for one</label>
        <div id="passportFields">
          <label>Passport Number</label>
          <input type="text" name="passportNumber">
          <label>Expiry Date</label>
          <input type="date" name="passportExpiry">
          <label>Upload Passport Copy</label>
          <input type="file" name="passportScan" accept="application/pdf,image/*">
        </div>
        <div id="newPassportFields" class="hidden">
          <label>Intended Issue Date</label>
          <input type="date" name="intendedIssue">
          <label>Upload Proof of Application</label>
          <input type="file" name="newPassportProof" accept="application/pdf,image/*">
        </div>
      </fieldset>

      <fieldset>
        <legend>Visa Type & Documents</legend>
        <label>Visa Type</label>
        <select name="visaType" required>
          <option value="">Select</option>
          <option>Relocation</option>
          <option>Sponsorship</option>
          <option>Work Visa</option>
        </select>
        <label>Proof of Booking</label>
        <input type="file" name="bookingProof" accept="application/pdf,image/*" required>
        <label>Flight Number</label>
        <input type="text" name="flightNumber">
        <label>Travel Insurance</label>
        <input type="file" name="insurance" accept="application/pdf,image/*" required>
        <label>Police Clearance</label>
        <input type="file" name="policeClearance" accept="application/pdf,image/*" required>
        <label>Medical Records</label>
        <input type="file" name="medicalRecords" accept="application/pdf,image/*" required>
        <label>Language Test Results</label>
        <input type="file" name="languageTest" accept="application/pdf,image/*">
        <label>Psychological Evaluation</label>
        <input type="text" name="psychDoctor" placeholder="Doctor's name & practice no.">
        <input type="file" name="psychProof" accept="application/pdf,image/*">
      </fieldset>

      <fieldset>
        <legend>Spouse & Children</legend>
        <label><input type="checkbox" id="includeSpouse"> Include Spouse</label>
        <div id="spouseSection" class="hidden">
          <label>Spouse Full Name</label>
          <input type="text" name="spouseName">
          <label>Spouse ID/Passport</label>
          <input type="text" name="spouseID">
          <label>Spouse Medical Records</label>
          <input type="file" name="spouseMedical" accept="application/pdf,image/*">
        </div>
        <label><input type="checkbox" id="includeChildren"> Include Children</label>
        <div id="childrenSection" class="hidden">
          <label>Number of Children</label>
          <select id="childrenCount" name="childrenCount">
            <option value="0">0</option><option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option><option value="5">5</option>
          </select>
          <div id="childrenContainer"></div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Submission</legend>
        <label>Booking Reference</label>
        <input type="text" id="bookingRef" name="bookingRef" required>
        <div id="formFeedback" class="feedback"></div>
        <button type="submit" id="submitBtn">Submit Visa Application</button>
      </fieldset>

    </form>
  </main>

  <script>
    const noPassport = document.getElementById('noPassport');
    const passportFields = document.getElementById('passportFields');
    const newPassportFields = document.getElementById('newPassportFields');
    const includeSpouse = document.getElementById('includeSpouse');
    const spouseSection = document.getElementById('spouseSection');
    const includeChildren = document.getElementById('includeChildren');
    const childrenSection = document.getElementById('childrenSection');
    const childrenCount = document.getElementById('childrenCount');
    const childrenContainer = document.getElementById('childrenContainer');
    const feedback = document.getElementById('formFeedback');
    const form = document.getElementById('visaForm');
    const submitBtn = document.getElementById('submitBtn');

    noPassport.addEventListener('change', ()=>{
      passportFields.classList.toggle('hidden', noPassport.checked);
      newPassportFields.classList.toggle('hidden', !noPassport.checked);
    });
    includeSpouse.addEventListener('change', ()=>{
      spouseSection.classList.toggle('hidden', !includeSpouse.checked);
    });
    includeChildren.addEventListener('change', ()=>{
      childrenSection.classList.toggle('hidden', !includeChildren.checked);
      childrenContainer.innerHTML = '';
      childrenCount.value = '0';
    });
    childrenCount.addEventListener('change', ()=>{
      childrenContainer.innerHTML = '';
      for(let i=1;i<=childrenCount.value;i++){
        const fs = document.createElement('fieldset');
        fs.innerHTML = `
          <legend>Child ${i}</legend>
          <label>Name</label>
          <input type="text" name="child_${i}_name" required>
          <label>ID/Passport</label>
          <input type="text" name="child_${i}_id" required>
          <label>Medical Records</label>
          <input type="file" name="child_${i}_medical" accept="application/pdf,image/*" required>
          <label>School Acceptance Letter</label>
          <input type="file" name="child_${i}_school" accept="application/pdf,image/*">
        `;
        childrenContainer.appendChild(fs);
      }
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      feedback.textContent = '';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      try {
        const fd = new FormData(form);
        const resp = await fetch('/api/submit', { method: 'POST', body: fd });
        if(resp.ok){
          const json = await resp.json();
          if(json.status === 'accepted'){
            feedback.textContent = 'Application accepted. Reference: '+json.reference;
            feedback.className = 'success feedback';
            form.reset();
            spouseSection.classList.add('hidden');
            childrenSection.classList.add('hidden');
            childrenContainer.innerHTML = '';
          } else {
            feedback.textContent = 'Application rejected: '+(json.message || 'Unknown');
            feedback.className = 'error feedback';
          }
        } else {
          feedback.textContent = 'Server error.';
          feedback.className = 'error feedback';
        }
      } catch(err){
        feedback.textContent = 'Network error: '+err.message;
        feedback.className = 'error feedback';
      }
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Visa Application';
    });

    // Prefill bookingData from localStorage
    window.onload = ()=>{
      const bookingData = JSON.parse(localStorage.getItem('bookingData'));
      if (bookingData) {
        document.getElementById('id_number').value = bookingData.id_number || '';
        document.getElementById('forenames').value = bookingData.forenames || '';
        document.getElementById('surname').value = bookingData.surname || '';
        document.getElementById('cellphone').value = bookingData.cellphone || '';
        document.getElementById('email').value = bookingData.email || '';
        document.getElementById('appointment_date').value = bookingData.appointment_date || '';
        document.getElementById('appointment_time').value = bookingData.appointment_time || '';
      } else {
        alert('No booking data found. Please complete the booking first.');
        window.location.href = 'summary.html';
      }
    }
  </script>
</body>
</html>
