<script>
  const form = document.getElementById('visaApplicationForm');

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    // Gather all input values
    const formData = new FormData(form);

    const application = {
      firstName: formData.get('firstName'),
      surname: formData.get('surname'),
      email: formData.get('email'),
      cellphone: formData.get('cellphone'),
      includeSpouse: formData.get('includeSpouse'),
      spouseName: formData.get('spouseName') || "",
      spouseSurname: formData.get('spouseSurname') || "",
      spouseID: formData.get('spouseID') || "",
      passportFile: formData.get('passportFile') ? formData.get('passportFile').name : "",
      passportNumber: formData.get('passportNumber') || "",
      passportExpiry: formData.get('passportExpiry') || "",
      intendedIssueDate: formData.get('intendedIssueDate') || "",
      passportProof: formData.get('passportProof') ? formData.get('passportProof').name : "",
      hasPassport: formData.get('hasPassport'),
      children: [],
      flightInvoice: formData.get('flightInvoice') ? formData.get('flightInvoice').name : "",
      travelItinerary: formData.get('travelItinerary') ? formData.get('travelItinerary').name : "",
      travelInsurance: formData.get('travelInsurance') ? formData.get('travelInsurance').name : "",
      fingerprintClearance: formData.get('fingerprintClearance') ? formData.get('fingerprintClearance').name : "",
      medicalRecords: formData.get('medicalRecords') ? formData.get('medicalRecords').name : "",
      submissionStatus: "Pending"
    };

    // Gather children info if any
    const childrenContainer = document.getElementById('childrenContainer');
    if(childrenContainer.children.length > 0){
      Array.from(childrenContainer.children).forEach((childDiv, index) => {
        const childIndex = index + 1;
        application.children.push({
          name: formData.get(`child${childIndex}Name`) || "",
          surname: formData.get(`child${childIndex}Surname`) || "",
          birthCert: formData.get(`child${childIndex}BirthCert`) ? formData.get(`child${childIndex}BirthCert`).name : "",
          schoolReport: formData.get(`child${childIndex}SchoolReport`) ? formData.get(`child${childIndex}SchoolReport`).name : ""
        });
      });
    }

    // Load existing applications from localStorage
    let visaApplications = JSON.parse(localStorage.getItem('visaApplicationsList')) || [];
    visaApplications.push(application);

    // Save back to localStorage
    localStorage.setItem('visaApplicationsList', JSON.stringify(visaApplications));

    alert('Application submitted successfully!');

    // Optionally, redirect to summary or clear form
    // window.location.href = 'summary.html';
    form.reset();
    document.getElementById('spouseFields').classList.add('hidden');
    document.getElementById('childrenFields').classList.add('hidden');
    document.getElementById('passportYesFields').classList.add('hidden');
    document.getElementById('passportNoFields').classList.add('hidden');
    document.getElementById('childrenContainer').innerHTML = "";
  });
</script>
