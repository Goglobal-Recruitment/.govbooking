const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const phoneInput = document.getElementById('phone');
const dateInput = document.getElementById('date');
const timeSelect = document.getElementById('time');
const authButton = document.getElementById('authButton');
const submitButton = document.getElementById('submitButton');
const bookingForm = document.getElementById('bookingForm');

// Generate times (8:00 - 17:00 in 30min steps)
const times = [];
for(let h=8; h<=16; h++){
  times.push(`${h.toString().padStart(2,'0')}:00`);
  times.push(`${h.toString().padStart(2,'0')}:30`);
}
times.push("17:00");

function populateTimes(availableTimes){
  timeSelect.innerHTML = "";
  times.forEach(t => {
    const option = document.createElement('option');
    option.value = t;
    option.textContent = t;
    if(availableTimes && availableTimes.includes(t)){
      option.disabled = true;
    }
    timeSelect.appendChild(option);
  });
}

// Fetch availability when date changes
dateInput.addEventListener('change', async ()=>{
  try {
    const res = await fetch(`/availability?date=${dateInput.value}`);
    const data = await res.json();
    populateTimes(data.bookedTimes);
  } catch (err) {
    console.error("Error fetching availability", err);
  }
});

// Auth button
authButton.addEventListener('click', async ()=>{
  const res = await fetch('/auth', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      name: nameInput.value,
      email: emailInput.value,
      phone: phoneInput.value
    })
  });
  const data = await res.json();
  if(data.authorized){
    submitButton.disabled = false;
    alert("‚úÖ Authenticated! You can now submit.");
  } else {
    alert("‚ùå Authentication failed. Check inputs.");
  }
});

// Submit form
bookingForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const res = await fetch('/book', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      name: nameInput.value,
      email: emailInput.value,
      phone: phoneInput.value,
      date: dateInput.value,
      time: timeSelect.value
    })
  });
  const data = await res.json();
  if(data.success){
    alert("üéâ Booking successful!");
    bookingForm.reset();
    submitButton.disabled = true;
  } else {
    alert("‚ö†Ô∏è Booking failed: " + data.message);
  }
});
