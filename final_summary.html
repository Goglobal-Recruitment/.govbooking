<script>
function submitVisaApplication() {
  // Gather personal info
  const userData = {
    booking_number: document.getElementById("booking_number").value,
    id_number: document.getElementById("id_number").value,
    forenames: document.getElementById("forenames").value,
    surname: document.getElementById("surname").value,
    email: document.getElementById("email").value,
    cellphone_full: document.getElementById("cellphone_full").value,
    country: document.getElementById("country").value,
    location: document.getElementById("location").value,
    office: document.getElementById("office").value,
    appointment_date: document.getElementById("appointment_date").value,
    appointment_time: document.getElementById("appointment_time").value
  };

  // User documents
  const userDocuments = [];
  if(document.getElementById("flight_invoice").files.length > 0) {
    userDocuments.push({ name: "Flight Invoice", status: "Pending" });
  }
  if(document.getElementById("travel_itinerary").files.length > 0) {
    userDocuments.push({ name: "Travel Itinerary", status: "Pending" });
  }
  if(document.getElementById("travel_insurance").files.length > 0) {
    userDocuments.push({ name: "Travel Insurance", status: "Pending" });
  }
  if(document.getElementById("fingerprint_clearance").files.length > 0) {
    userDocuments.push({ name: "Fingerprint Clearance", status: "Pending" });
  }
  if(document.getElementById("medical_records").files.length > 0) {
    userDocuments.push({ name: "Medical Records", status: "Pending" });
  }

  // Spouse documents
  const spouseDocuments = [];
  if(document.getElementById("includeSpouse").value === "Yes") {
    if(document.getElementById("spouse_passport_file") && document.getElementById("spouse_passport_file").files.length>0){
      spouseDocuments.push({ name: "Passport", status: "Pending" });
    }
    if(document.getElementById("spouse_proof_file") && document.getElementById("spouse_proof_file").files.length>0){
      spouseDocuments.push({ name: "Passport Application Proof", status: "Pending" });
    }
  }

  // Children documents
  const childrenDocuments = [];
  const numChildren = parseInt(document.getElementById("num_children")?.value || 0);
  for(let i=1;i<=numChildren;i++){
    const childDocs = [];
    const passportFile = document.getElementById(`child${i}_passport_file`);
    if(passportFile && passportFile.files.length>0){
      childDocs.push({ name: "Passport", status: "Pending" });
    }
    const proofFile = document.getElementById(`child${i}_proof_file`);
    if(proofFile && proofFile.files.length>0){
      childDocs.push({ name: "Passport Application Proof", status: "Pending" });
    }
    const childName = document.getElementById(`child${i}_name`)?.value || `Child ${i}`;
    childrenDocuments.push({ name: childName, documents: childDocs });
  }

  // Spouse name for Final Summary
  const spouseName = document.getElementById("spouse_name")?.value || "";

  // Save to localStorage in a structured way
  const visaApplication = {
    ...userData,
    userDocuments: userDocuments,
    spouseDocuments: spouseDocuments,
    spouse_name: spouseName,
    childrenDocuments: childrenDocuments
  };

  localStorage.setItem('visaApplication', JSON.stringify(visaApplication));

  // Redirect to final summary page
  window.location.href = "final_summary.html";
}
</script>
